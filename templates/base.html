<!doctype html>
{% load static %}
<html lang="id">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Sistem Point of Sale untuk manajemen toko dan inventory">
    <meta name="theme-color" content="#1e40af">
    <title>mini_pos - {% block title %}{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mini POS">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="{% static 'icons/favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'icons/favicon-96x96.png' %}">
    <link rel="shortcut icon" href="{% static 'icons/favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'icons/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'icons/icon-192x192.png' %}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=20251124b">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/theme-default.css' %}?v=20251124b">
  </head>
  <body>
    
    <div class="app-shell">
      <div class="app-main">
        <header class="app-topbar">
          <div class="d-flex align-items-center justify-content-between px-4">
            <!-- LEFT: Brand -->
            <div class="d-flex align-items-center gap-3 flex-shrink-0">
              <a class="topbar-brand d-flex align-items-center" href="{% url 'dashboard' %}">
                <span class="brand-icon"><i class="bi bi-cart3"></i></span>
                <span class="brand-text">Mini POS</span>
              </a>
            </div>
            <!-- RIGHT: Nav + Mobile Dropdown + Logout -->
            <div class="d-flex align-items-center gap-2 ms-auto">
              <nav class="topbar-nav d-none d-lg-flex align-items-center gap-2">
              <a class="nav-link px-3 {% if request.path == '/' %}active{% endif %}" href="{% url 'dashboard' %}"><i class="bi bi-house-door-fill me-1"></i> <span class="d-none d-xl-inline">Beranda</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:11" == '/categories' %}active{% endif %}" href="{% url 'category_list' %}"><i class="bi bi-tag me-1"></i> <span class="d-none d-xl-inline">Kategori</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:9" == '/products' %}active{% endif %}" href="{% url 'product_list' %}"><i class="bi bi-box-seam me-1"></i> <span class="d-none d-xl-inline">Produk</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:10" == '/suppliers' %}active{% endif %}" href="{% url 'supplier_list' %}"><i class="bi bi-truck me-1"></i> <span class="d-none d-xl-inline">Supplier</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:16" == '/purchase-orders' %}active{% endif %}" href="{% url 'purchase_order_list' %}"><i class="bi bi-clipboard-check me-1"></i> <span class="d-none d-xl-inline">PO</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:10" == '/customers' %}active{% endif %}" href="{% url 'customer_list' %}"><i class="bi bi-people me-1"></i> <span class="d-none d-xl-inline">Pelanggan</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:7" == '/orders' %}active{% endif %}" href="{% url 'orders_list' %}"><i class="bi bi-receipt me-1"></i> <span class="d-none d-xl-inline">Pesanan</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:8" == '/reports' %}active{% endif %}" href="{% url 'reports' %}"><i class="bi bi-graph-up me-1"></i> <span class="d-none d-xl-inline">Laporan</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:11" == '/analytics' %}active{% endif %}" href="{% url 'analytics' %}"><i class="bi bi-bar-chart-line me-1"></i> <span class="d-none d-xl-inline">Analytics</span></a>
              <a class="nav-link px-3 {% if request.path|slice:"0:9" == '/backups/' %}active{% endif %}" href="{% url 'backups_list' %}"><i class="bi bi-hdd-network me-1"></i> <span class="d-none d-xl-inline">Backup</span></a>
              </nav>
              <!-- Mobile Menu Dropdown moved to right -->
              <div class="dropdown d-lg-none">
                <button class="btn btn-ghost btn-sm" type="button" id="mobileMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-list" style="font-size: 1.6rem;"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="mobileMenuDropdown" style="min-width: 220px;">
                  <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="bi bi-house-door-fill me-2"></i> Beranda</a></li>
                  <li><a class="dropdown-item" href="{% url 'category_list' %}"><i class="bi bi-tag me-2"></i> Kategori</a></li>
                  <li><a class="dropdown-item" href="{% url 'product_list' %}"><i class="bi bi-box-seam me-2"></i> Produk</a></li>
                  <li><a class="dropdown-item" href="{% url 'supplier_list' %}"><i class="bi bi-truck me-2"></i> Supplier</a></li>
                  <li><a class="dropdown-item" href="{% url 'purchase_order_list' %}"><i class="bi bi-clipboard-check me-2"></i> Purchase Order</a></li>
                  <li><a class="dropdown-item" href="{% url 'customer_list' %}"><i class="bi bi-people me-2"></i> Pelanggan</a></li>
                  <li><a class="dropdown-item" href="{% url 'orders_list' %}"><i class="bi bi-receipt me-2"></i> Pesanan</a></li>
                  <li><a class="dropdown-item" href="{% url 'reports' %}"><i class="bi bi-graph-up me-2"></i> Laporan</a></li>
                  <li><a class="dropdown-item" href="{% url 'analytics' %}"><i class="bi bi-bar-chart-line me-2"></i> Analytics</a></li>
                  <li><a class="dropdown-item" href="{% url 'backups_list' %}"><i class="bi bi-hdd-network me-2"></i> Backup</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                </ul>
              </div>
              <div class="user-menu d-none d-lg-block">
                <a class="btn btn-sm btn-outline-light" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-1"></i> Logout</a>
              </div>
            </div>
          </div>
        </header>

        <main class="app-content container-fluid">
          <div class="pt-3">
            <div class="page-hero mb-3">
              {% block page_title %}{% endblock %}
            </div>
            {% if messages %}
              <div class="mb-3">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% block content %}{% endblock %}
          </div>
        </main>
      </div>
    </div>

    <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'vendor/select2/select2.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Populate the page header from the document title (remove "mini_pos - ")
      try {
        const header = document.querySelector('.app-title');
        if (header) header.textContent = document.title.replace(/^mini_pos -\s*/i, '');
      } catch (e) { /* ignore */ }
    </script>
    <script>
      // Sidebar toggle behavior and responsive collapse
      (function(){
        const sidebar = document.querySelector('.app-sidebar');
        const toggle = document.getElementById('sidebarToggle');
        function setCollapsed(v){
          if(!sidebar) return;
          if(v) sidebar.classList.add('collapsed'); else sidebar.classList.remove('collapsed');
          try{ localStorage.setItem('mini_pos_sidebar_collapsed', v ? '1' : '0'); }catch(e){}
        }
        // restore preference
        try{
          const pref = localStorage.getItem('mini_pos_sidebar_collapsed');
          if(pref==='1') setCollapsed(true);
        }catch(e){}
        if(toggle){
          toggle.addEventListener('click', function(){
            const isCollapsed = sidebar.classList.contains('collapsed');
            setCollapsed(!isCollapsed);
          });
        }
        // auto-collapse on small screens
        function handleResize(){ if(window.innerWidth < 992){ setCollapsed(true); } else { const pref = localStorage.getItem('mini_pos_sidebar_collapsed'); if(pref===null) setCollapsed(false); }}
        window.addEventListener('resize', handleResize);
        handleResize();
      })();
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{% static 'sw.js' %}")
            .then((registration) => {
              console.log('✅ Service Worker registered:', registration.scope);
            })
            .catch((error) => {
              console.log('❌ Service Worker registration failed:', error);
            });
        });
      }
      
      // PWA Install Prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button/banner (optional)
        const installBanner = document.createElement('div');
        installBanner.innerHTML = `
          <div class="alert alert-info alert-dismissible fade show position-fixed bottom-0 start-50 translate-middle-x m-3" 
               style="z-index: 9999; max-width: 500px;" role="alert">
            <i class="bi bi-download me-2"></i>
            <strong>Install Mini POS</strong>
            <p class="mb-2 small">Install aplikasi ini di perangkat Anda untuk akses lebih cepat!</p>
            <button class="btn btn-sm btn-primary me-2" id="installBtn">
              <i class="bi bi-plus-circle me-1"></i> Install Sekarang
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        document.body.appendChild(installBanner);
        
        document.getElementById('installBtn').addEventListener('click', async () => {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response: ${outcome}`);
          deferredPrompt = null;
          installBanner.remove();
        });
      });
      
      // Installed event
      window.addEventListener('appinstalled', () => {
        console.log('✅ PWA installed successfully!');
        deferredPrompt = null;
      });
    </script>
    
    {% block scripts %}{% endblock %}
  </body>
</html>
