{% extends 'base.html' %}
{% block title %}Buat Purchase Order{% endblock %}
{% block page_title %}
  {% include 'pos/_hero.html' with title='Buat Purchase Order Baru' subtitle='Pesanan pembelian dari supplier' icon='bi bi-clipboard-check' %}
{% endblock %}
{% block content %}
<div class="card p-4">
  <form method="post" id="poForm">
    {% csrf_token %}
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Supplier <span class="text-danger">*</span></label>
        <select name="supplier" class="form-control" required>
          <option value="">Pilih Supplier</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Nomor PO <span class="text-danger">*</span></label>
        <input type="text" name="order_number" class="form-control" placeholder="PO-2024001" required>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Catatan</label>
      <textarea name="notes" class="form-control" rows="2"></textarea>
    </div>

    <hr>
    <h6 class="mb-3">Item Produk</h6>
    <div id="itemsContainer">
      <div class="row g-2 mb-2 item-row">
        <div class="col-md-5">
          <label class="form-label">Produk</label>
          <select name="product" class="form-control product-select" required>
            <option value="">Pilih Produk</option>
            {% for p in products %}
              <option value="{{ p.id }}">{{ p.name }} (Stok: {{ p.stock }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Jumlah</label>
          <input type="number" name="quantity" class="form-control" min="1" value="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Harga Satuan</label>
          <input type="number" name="unit_price" class="form-control" min="0" step="0.01" value="0" required>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="button" class="btn btn-danger btn-sm remove-item" style="display:none;"><i class="bi bi-trash"></i></button>
        </div>
      </div>
    </div>

    <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="addItemBtn">
      <i class="bi bi-plus-circle"></i> Tambah Item
    </button>

    <hr>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0">Total:</h6>
      <h5 class="mb-0" id="totalAmount">Rp 0</h5>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">Buat Purchase Order</button>
      <a href="{% url 'purchase_order_list' %}" class="btn btn-secondary">Batal</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const itemsContainer = document.getElementById('itemsContainer');
  const addItemBtn = document.getElementById('addItemBtn');
  let itemCount = 1;

  function updateTotal() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(row => {
      const qty = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name="unit_price"]').value) || 0;
      total += qty * price;
    });
    document.getElementById('totalAmount').textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(total);
  }

  function addItem() {
    const template = document.querySelector('.item-row').cloneNode(true);
    template.querySelectorAll('input').forEach(input => input.value = input.type === 'number' ? (input.name === 'quantity' ? '1' : '0') : '');
    template.querySelector('select').selectedIndex = 0;
    template.querySelector('.remove-item').style.display = 'inline-block';
    itemsContainer.appendChild(template);
    updateRemoveButtons();
    attachListeners();
  }

  function updateRemoveButtons() {
    const items = document.querySelectorAll('.item-row');
    items.forEach((item, index) => {
      const removeBtn = item.querySelector('.remove-item');
      removeBtn.style.display = items.length > 1 ? 'inline-block' : 'none';
    });
  }

  function attachListeners() {
    document.querySelectorAll('.item-row').forEach(row => {
      row.querySelectorAll('input').forEach(input => {
        input.removeEventListener('input', updateTotal);
        input.addEventListener('input', updateTotal);
      });
      row.querySelector('.remove-item').onclick = function() {
        if (document.querySelectorAll('.item-row').length > 1) {
          row.remove();
          updateRemoveButtons();
          updateTotal();
        }
      };
    });
  }

  addItemBtn.addEventListener('click', addItem);
  attachListeners();
  updateTotal();
});
</script>
{% endblock %}
